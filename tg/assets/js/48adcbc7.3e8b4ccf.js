"use strict";(self.webpackChunkm_19_v=self.webpackChunkm_19_v||[]).push([[5845],{5567:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"notes/software-engineering/terraform","title":"Terraform","description":"What is Terraform?","source":"@site/docs/notes/software-engineering/terraform.md","sourceDirName":"notes/software-engineering","slug":"/notes/software-engineering/terraform","permalink":"/tg/docs/notes/software-engineering/terraform","draft":false,"unlisted":false,"editUrl":"https://github.com/m19v/m19v.github.io/blob/main/docs/notes/software-engineering/terraform.md","tags":[],"version":"current","lastUpdatedBy":"m19v","lastUpdatedAt":1761828399000,"frontMatter":{"title":"Terraform"},"sidebar":"tutorialSidebar","previous":{"title":"Quarkus","permalink":"/tg/docs/notes/software-engineering/quarkus"},"next":{"title":"References","permalink":"/tg/docs/category/references"}}');var i=r(4848),l=r(8453);const a={title:"Terraform"},o=void 0,t={},c=[{value:"What is Terraform?",id:"what-is-terraform",level:2},{value:"Terraform vs. Ansible",id:"terraform-vs-ansible",level:2},{value:"Provisioning cloud resources",id:"provisioning-cloud-resources",level:2},{value:"Categories of IaC tools",id:"categories-of-iac-tools",level:2},{value:"IaC Provisioning tools landscape",id:"iac-provisioning-tools-landscape",level:2},{value:"Common patterns of terraform usage",id:"common-patterns-of-terraform-usage",level:2},{value:"Terraform architecture",id:"terraform-architecture",level:2},{value:"Terraform project structure",id:"terraform-project-structure",level:2},{value:"Providers",id:"providers",level:2},{value:"Modules",id:"modules",level:2},{value:"Types of modules",id:"types-of-modules",level:3},{value:"Module sources",id:"module-sources",level:3},{value:"Good modules",id:"good-modules",level:3},{value:"State file",id:"state-file",level:2},{value:"Terraform basic usage sequence",id:"terraform-basic-usage-sequence",level:2},{value:"Variables and Outputs",id:"variables-and-outputs",level:2},{value:"Variable types",id:"variable-types",level:3},{value:"Setting input variables",id:"setting-input-variables",level:3},{value:"Ways to assign values to variables",id:"ways-to-assign-values-to-variables",level:3},{value:"Sensitive variables",id:"sensitive-variables",level:2},{value:"Types and validation",id:"types-and-validation",level:2},{value:"Primitive types",id:"primitive-types",level:3},{value:"Complex types",id:"complex-types",level:3},{value:"Validation",id:"validation",level:3},{value:"Expressions",id:"expressions",level:2},{value:"Functions",id:"functions",level:2},{value:"Meta arguments",id:"meta-arguments",level:2},{value:"<code>depends_on</code>",id:"depends_on",level:3},{value:"<code>count</code>",id:"count",level:3},{value:"<code>for_each</code>",id:"for_each",level:3},{value:"<code>lifecycle</code>",id:"lifecycle",level:3},{value:"Inputs + Meta arguments",id:"inputs--meta-arguments",level:3},{value:"Provisioners",id:"provisioners",level:2},{value:"Managing multiple environments",id:"managing-multiple-environments",level:2},{value:"Terraform workspaces",id:"terraform-workspaces",level:3},{value:"File structure",id:"file-structure",level:3},{value:"Terragrunt",id:"terragrunt",level:3},{value:"Testing terraform code",id:"testing-terraform-code",level:2},{value:"Static checks",id:"static-checks",level:3},{value:"Developer workflows",id:"developer-workflows",level:2},{value:"General workflow",id:"general-workflow",level:3},{value:"Multi account/project",id:"multi-accountproject",level:3},{value:"Additional tools",id:"additional-tools",level:3},{value:"Potential pitfalls",id:"potential-pitfalls",level:3},{value:"Commands",id:"commands",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"what-is-terraform",children:"What is Terraform?"}),"\n",(0,i.jsx)(n.p,{children:"Terraform is a declarative (i.e. end state to be declared/defined) infrastructure as code tool to automate build, change, and versioning of infrastructure safely and efficiently with"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"low-level components: compute instances, storage, networking etc."}),"\n",(0,i.jsx)(n.li,{children:"high-level components: DNS entries and SaaS features"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"terraform-vs-ansible",children:"Terraform vs. Ansible"}),"\n",(0,i.jsx)(n.p,{children:"Terraform mainly focuses on infrastructure provisioning while Ansible aims to configure that infrastructure."}),"\n",(0,i.jsx)(n.h2,{id:"provisioning-cloud-resources",children:"Provisioning cloud resources"}),"\n",(0,i.jsx)(n.p,{children:"Approaches:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"GUI"}),"\n",(0,i.jsx)(n.li,{children:"API/CLI"}),"\n",(0,i.jsx)(n.li,{children:"IaC (Infrastructure as Code)"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"categories-of-iac-tools",children:"Categories of IaC tools"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Ad hoc scripts"}),"\n",(0,i.jsx)(n.li,{children:"Configuration management tools"}),"\n",(0,i.jsx)(n.li,{children:"Server templating tools"}),"\n",(0,i.jsx)(n.li,{children:"Orchestration tools"}),"\n",(0,i.jsx)(n.li,{children:"Provisioning tools"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"iac-provisioning-tools-landscape",children:"IaC Provisioning tools landscape"}),"\n",(0,i.jsx)(n.p,{children:"Cloud specific:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Cloud Foundation"}),"\n",(0,i.jsx)(n.li,{children:"Azure Resource Manager"}),"\n",(0,i.jsx)(n.li,{children:"Google Cloud Deployment Manager"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Cloud agnostic:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Terraform"}),"\n",(0,i.jsx)(n.li,{children:"Pulumi"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"common-patterns-of-terraform-usage",children:"Common patterns of terraform usage"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Terraform (Provisioning) + Ansible (Config Management)"}),"\n",(0,i.jsx)(n.li,{children:"Terraform (Provisioning) + Packer (Server Templating)"}),"\n",(0,i.jsx)(n.li,{children:"Terraform (Provisioning) + Kubernetes (Orchestration)"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"terraform-architecture",children:"Terraform architecture"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"+------------------+\n|  Terraform State |\n+------------------+ <-----\x3e +----------------+         +--------------+         +-----+\n                             | Terraform Core | <-----\x3e | AWS Provider | <-----\x3e | AWS |\n+------------------+ ------\x3e +----------------+         +--------------+         +-----+\n| Terraform Config |\n+------------------+         \n"})}),"\n",(0,i.jsx)(n.h2,{id:"terraform-project-structure",children:"Terraform project structure"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"project\n    .terraform\n        modules\n            modules.json\n            ...\n        provides\n            ...\n        terraform.tfstate\n    .terraform.lock.hcl\n    main.tf\n"})}),"\n",(0,i.jsx)(n.h2,{id:"providers",children:"Providers"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://registry.terraform.io/browse/providers",children:"Terraform providers"})," are plugins that enable interaction with a resource API."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'terraform {\n  required_providers {\n    ibm = {\n      source = "IBM-Cloud/ibm"\n      version = ">= 1.12.0"\n    }\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"modules",children:"Modules"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Modules are containers for multiple resources that are used together. A module consists of a collection of ",(0,i.jsx)(n.code,{children:".tf"})," and/or ",(0,i.jsx)(n.code,{children:".tf.json"})," files kept together in a directory"]}),"\n",(0,i.jsx)(n.li,{children:"Modules are the main way to package and reuse resource configurations with terraform"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"types-of-modules",children:"Types of modules"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Root module"})," is a default module containing all ",(0,i.jsx)(n.code,{children:".tf"})," files in main working directory"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Child module"})," is a separate external module referred to from a ",(0,i.jsx)(n.code,{children:".tf"})," file"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"module-sources",children:"Module sources"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Local paths","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'module "consul" {\n  source = "./consul"\n}\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Terraform Registry","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'module "consul" {\n  source = "hashicorp/consul/aws"\n  version = "0.1.0"\n}\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["GitHub","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'module "consul" {\n  source = "git@github.com:hashicorp/example.git"\n}\n'})}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Bitbucket"}),"\n",(0,i.jsx)(n.li,{children:"Generic Git, Mercurial repositories"}),"\n",(0,i.jsx)(n.li,{children:"HTTP URLs"}),"\n",(0,i.jsx)(n.li,{children:"S3 buckets"}),"\n",(0,i.jsx)(n.li,{children:"GCS buckets"}),"\n",(0,i.jsx)(n.li,{children:"Modules in Package Sub-directories"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"good-modules",children:"Good modules"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Raises the abstraction level from base resource types"}),"\n",(0,i.jsx)(n.li,{children:"Groups resources in a logical fashion"}),"\n",(0,i.jsx)(n.li,{children:"Exposes input variables to allow necessary customization + composition"}),"\n",(0,i.jsx)(n.li,{children:"Provides useful defaults"}),"\n",(0,i.jsx)(n.li,{children:"Returns outputs to make further integrations possible"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"state-file",children:"State file"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"terraform.tfstate:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Terraform's representation of the world"}),"\n",(0,i.jsx)(n.li,{children:"JSON file containing information about every resource and data object"}),"\n",(0,i.jsx)(n.li,{children:"Contains sensitive info (e.g. database password), hence it should have restricted access and be encrypted"}),"\n",(0,i.jsxs)(n.li,{children:["Can be stored ",(0,i.jsx)(n.strong,{children:"locally/local_backend"})," or ",(0,i.jsx)(n.strong,{children:"remotely/remote_backend"})," (in object store like S3 bucket, google cloud storage)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"terraform-basic-usage-sequence",children:"Terraform basic usage sequence"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["terraform init","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"inits project and downloads associated providers to working directory from terraform registry"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["terraform plan","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["compares ",(0,i.jsx)(n.em,{children:"desired state"})," (terraform config) with ",(0,i.jsx)(n.em,{children:"actual state"}),"(terraform state)."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["terraform apply","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"apply terraform plan using providers"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["terraform destroy","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"destroys all resources and data"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"variables-and-outputs",children:"Variables and Outputs"}),"\n",(0,i.jsx)(n.h3,{id:"variable-types",children:"Variable types"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Input variables"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"var.<name>"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'variable "instance_type" {\n  description = "es2 instance type"\n  type = string\n  default = "t2.micro"\n}\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Local variables"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"local.<name>"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'locals {\n  service_name = "My Service"\n  owner = "Devops Directive"\n}\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Output variables"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'output "instance_ip_addr" {\n  value = aws_instance.instance.public_ip\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"setting-input-variables",children:"Setting input variables"}),"\n",(0,i.jsx)(n.p,{children:"(in order of precedence, lowest -> highest)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Manual entry during plan/apply"}),"\n",(0,i.jsx)(n.li,{children:"Default value in declaration block"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"TF_VAR_\\<name\\>"})," environment variables"]}),"\n",(0,i.jsx)(n.li,{children:"terraform.tfvars file"}),"\n",(0,i.jsx)(n.li,{children:"*.auto.tfvars file"}),"\n",(0,i.jsxs)(n.li,{children:["Command line ",(0,i.jsx)(n.code,{children:"-var"})," or ",(0,i.jsx)(n.code,{children:"-var-file"}),". E.g. ",(0,i.jsx)(n.code,{children:'-var="var_name=var_value"'})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"ways-to-assign-values-to-variables",children:"Ways to assign values to variables"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'# .tfvars file (Recommended method)\ntf apply -var-file my-vars.tfvars\n\n# CLI options\ntf apply -var project_id="my-project"\n\n# environment variables\nTF_VAR_project_id="my-project" && tf apply\n\n# If using terraform.tfvars\ntf apply\n'})}),"\n",(0,i.jsx)(n.h2,{id:"sensitive-variables",children:"Sensitive variables"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Mark variables as sensitive:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"sensitive = true"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Pass to terraform apply with:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"TF_VAR_variable"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"-var"})," (retrieve from secret manager at runtime)"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Can also use external secret store","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"E.g. AWS Secrets Manager"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"types-and-validation",children:"Types and validation"}),"\n",(0,i.jsx)(n.h3,{id:"primitive-types",children:"Primitive types"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"string"}),"\n",(0,i.jsx)(n.li,{children:"number"}),"\n",(0,i.jsx)(n.li,{children:"bool"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"complex-types",children:"Complex types"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"list(<TYP\\E>)"}),"\n",(0,i.jsx)(n.li,{children:"set(<TYPE>)"}),"\n",(0,i.jsx)(n.li,{children:"map(<TYPE>)"}),"\n",(0,i.jsx)(n.li,{children:"object({<ATTR NAME> = <TYPE>, ...})"}),"\n",(0,i.jsx)(n.li,{children:"tuple([<TYPE>, ...])"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"validation",children:"Validation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Type checking happens automatically"}),"\n",(0,i.jsx)(n.li,{children:"Custom conditions can also be enforced"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"expressions",children:"Expressions"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Types and Values"}),"\n",(0,i.jsx)(n.li,{children:"Strings and Templates"}),"\n",(0,i.jsx)(n.li,{children:"References to Values"}),"\n",(0,i.jsxs)(n.li,{children:["Operators - ",(0,i.jsx)(n.code,{children:"!, -, *, /, %, >, ==, etc."})]}),"\n",(0,i.jsx)(n.li,{children:"Function Calls"}),"\n",(0,i.jsxs)(n.li,{children:["Conditional Expressions - ",(0,i.jsx)(n.code,{children:"<CONDITION> ? <TRUE VAL> : <FALSE VAL>"})]}),"\n",(0,i.jsxs)(n.li,{children:["For Expressions - ",(0,i.jsx)(n.code,{children:"[for o in var.list : o.id]"})]}),"\n",(0,i.jsxs)(n.li,{children:["Splat Expressions - ",(0,i.jsx)(n.code,{children:"var.list[*].id"})]}),"\n",(0,i.jsx)(n.li,{children:"Dynamic Blocks"}),"\n",(0,i.jsx)(n.li,{children:"Type Constraints"}),"\n",(0,i.jsx)(n.li,{children:"Version Constraints"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"functions",children:"Functions"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Numeric"}),"\n",(0,i.jsx)(n.li,{children:"String"}),"\n",(0,i.jsx)(n.li,{children:"Collection"}),"\n",(0,i.jsx)(n.li,{children:"Encoding"}),"\n",(0,i.jsx)(n.li,{children:"Filesystem"}),"\n",(0,i.jsx)(n.li,{children:"Data & Time"}),"\n",(0,i.jsx)(n.li,{children:"Hash & Crypto"}),"\n",(0,i.jsx)(n.li,{children:"IP Network"}),"\n",(0,i.jsx)(n.li,{children:"Type conversion"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"meta-arguments",children:"Meta arguments"}),"\n",(0,i.jsx)(n.h3,{id:"depends_on",children:(0,i.jsx)(n.code,{children:"depends_on"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Terraform automatically generates dependency graph based on references"}),"\n",(0,i.jsxs)(n.li,{children:["If two resources depends on each other (but not each others data), ",(0,i.jsx)(n.code,{children:"depends_on"})," specifies that dependency to enforce ordering","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["e.g. if software on the instance needs access to S3, trying to create the ",(0,i.jsx)(n.em,{children:"aws_instance"})," would fail if atempting to create it before the ",(0,i.jsx)(n.em,{children:"aws_aim_role_policy"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'resource "aws_instance" "example" {\n  ami = "ami-1k2j123j"\n  instance_type = "t2.micro"\n\n  iam_instance_profile = aws_iam_instance_profile.example\n\n  depends_on = [\n    aws_iam_role_policy.example,\n  ]\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"count",children:(0,i.jsx)(n.code,{children:"count"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Allows for creation of multiple resources/modules from a single block"}),"\n",(0,i.jsx)(n.li,{children:"Useful when the multiple necessary resources are nearly identical"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'resource "aws_instance" "server" {\n  count = 4 # create four similar EC2 instances\n\n  ami           = "ami-a1b2c3d4"\n  instance_type = "t2.micro"\n\n  tags = {\n    Name = "Server ${count.index}"\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"for_each",children:(0,i.jsx)(n.code,{children:"for_each"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Allows for creation of multiple resources/modules from a single block"}),"\n",(0,i.jsxs)(n.li,{children:["Allows more control to customize each resource than ",(0,i.jsx)(n.code,{children:"count"})]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'locals {\n  subnet_ids = toset([\n    "subnet-abcdef",\n    "subnet-012345",\n  ])\n}\n\nresource "aws_instance" "server" {\n  for_each = local.subnet_ids\n\n  ami           = "ami-a1b2c3d4"\n  instance_type = "t2.micro"\n  subnet_id     = each.key # note: each.key and each.value are the same for a set\n\n  tags = {\n    Name = "Server ${each.key}"\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"lifecycle",children:(0,i.jsx)(n.code,{children:"lifecycle"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"A set of meta arguments to control terraform behavior for specific resources"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.em,{children:"create_before_destroy"})," can help with zero downtime deployments"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.em,{children:"ignore_changes"})," prevents terraform from trying to revert metadata being set elsewhere"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.em,{children:"prevent_destroy"})," causes terraform to reject any plan which would destroy this resource"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'resource "azurerm_resource_group" "example" {\n  # ...\n\n  lifecycle {\n    create_before_destroy = true\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"inputs--meta-arguments",children:"Inputs + Meta arguments"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"input variables are passed in via module block"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'module "web_app" {\n  source = "./web-app-module"\n\n  # Input variables\n  bucket_name = "devops-directive-web-app-data"\n  domain = "example.com"\n  db_name = "mydb"\n  db_user = "foo"\n  db_pass = var.db_pass\n}\n\n'})}),"\n",(0,i.jsx)(n.h2,{id:"provisioners",children:"Provisioners"}),"\n",(0,i.jsx)(n.p,{children:"Perform action on local or remote machine"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"file"}),"\n",(0,i.jsx)(n.li,{children:"local-exec"}),"\n",(0,i.jsx)(n.li,{children:"remote-exec"}),"\n",(0,i.jsxs)(n.li,{children:["vendor","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"chef"}),"\n",(0,i.jsx)(n.li,{children:"puppet"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"managing-multiple-environments",children:"Managing multiple environments"}),"\n",(0,i.jsx)(n.p,{children:"Approaches:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Workspaces"}),": multiple named section within a single backend"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"~ terraform workspace list\n   default\n * dev\n   staging\n   production \n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"File structure"}),": directory layout provides separation, modules provide reuse"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"_modules\n  module-1\n    main.tf\n    variables.tf\n  module-2\n    main.tf\n    variables.tf\ndev\n  main.tf\n  terraform.tfvars\nstaging\n  main.tf\n  terraform.tfvars\nproduction\n  main.tf\n  terraform.tfvars\n"})}),"\n",(0,i.jsx)(n.h3,{id:"terraform-workspaces",children:"Terraform workspaces"}),"\n",(0,i.jsx)(n.p,{children:"Pros:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Easy to get started"}),"\n",(0,i.jsxs)(n.li,{children:["Convenient ",(0,i.jsx)(n.code,{children:"terraform.workspace"})," expression"]}),"\n",(0,i.jsx)(n.li,{children:"Minimize code duplication\nCons:"}),"\n",(0,i.jsx)(n.li,{children:"Prone to human error"}),"\n",(0,i.jsx)(n.li,{children:"State stored within same backend"}),"\n",(0,i.jsx)(n.li,{children:"Codebase doesn't unambiguously show deployment configurations"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"file-structure",children:"File structure"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Further separation (at logical component groups) useful for larger projects","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Isolate things that change frequently from those which don't"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["References resources across configurations is possible using ",(0,i.jsx)(n.code,{children:"terraform_remote_state"})]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"_modules\n  compute-module\n    main.tf\n    variables.tf\n  networking-module\n    main.tf\n    variables.tf\ndev\n  compute\n    main.tf\n    terraform.tfvars\n  networking\n    main.tf\n    terraform.tfvars\nstaging\n  compute\n    main.tf\n    terraform.tfvars\n  networking\n    main.tf\n    terraform.tfvars\nproduction\n  compute\n    main.tf\n    terraform.tfvars\n  networking\n    main.tf\n    terraform.tfvars\n"})}),"\n",(0,i.jsx)(n.p,{children:"Pros:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Isolation of backends","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Improved security"}),"\n",(0,i.jsx)(n.li,{children:"Decreased potential for human error"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Codebase fully represents deployed state\nCons:"}),"\n",(0,i.jsxs)(n.li,{children:["Multiple ",(0,i.jsx)(n.code,{children:"terraform apply"})," required to provision environments"]}),"\n",(0,i.jsx)(n.li,{children:"More code duplication, but can be minimized with modules"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"terragrunt",children:"Terragrunt"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Tool by gruntwork.io that provides utilities to make certain terraform use cases easier","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Keeping terraform code DRY"}),"\n",(0,i.jsx)(n.li,{children:"Executing commands across multiple TG configs"}),"\n",(0,i.jsx)(n.li,{children:"Working with multiple cloud accounts"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"testing-terraform-code",children:"Testing terraform code"}),"\n",(0,i.jsx)(n.h3,{id:"static-checks",children:"Static checks"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Build-in"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["terraform fmt","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"terraform fmt -check # checks if formatter would make chances\nterraform fmt # applies those changes\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["terraform validate","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"terraform validate\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["terraform plan","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"terraform plan\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["custom validation rules","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'variable "short_variable" {\n  type = string\n\n  validation {\n    condition = length(var.short_variable) < 4\n    error_message = "The short_variable value must be less than 4 characters!"\n  }\n}\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"External"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"tflint"}),"\n",(0,i.jsx)(n.li,{children:"checkov, tfsec, terrascan, terraform-compliance, snyk"}),"\n",(0,i.jsx)(n.li,{children:"Terraform Sentinal (enterprise only)"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Manual testing"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Follow the standard Terraform workflow, running ",(0,i.jsx)(n.code,{children:"terraform init"}),", ",(0,i.jsx)(n.code,{children:"terraform apply"}),", and ",(0,i.jsx)(n.code,{children:"terraform destroy"})," to test your configuration manually."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Automated testing"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Automate the manual testing steps using a shell script or a more robust method, such as utilizing a testing framework like ",(0,i.jsx)(n.code,{children:"TerraTest"})," with Go to write complex tests and make assertions about your infrastructure."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"developer-workflows",children:"Developer workflows"}),"\n",(0,i.jsx)(n.h3,{id:"general-workflow",children:"General workflow"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Write/update code"}),"\n",(0,i.jsx)(n.li,{children:"Run changes locally (for development environment)"}),"\n",(0,i.jsx)(n.li,{children:"Create pull request"}),"\n",(0,i.jsx)(n.li,{children:"Run tests via CI"}),"\n",(0,i.jsx)(n.li,{children:"Deploy to staging via CD (on merge to main)"}),"\n",(0,i.jsx)(n.li,{children:"Deploy to production via CD (on release)"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"multi-accountproject",children:"Multi account/project"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Simplify IAM (Identity and Access Management) policies for enforcing controls for different environments (and remote TF backends)"}),"\n",(0,i.jsx)(n.li,{children:"Isolate environments to protect minimize blast radius"}),"\n",(0,i.jsx)(n.li,{children:"Reduce naming conflicts for resources"}),"\n",(0,i.jsx)(n.li,{children:"Con: Adds complexity to TF config (but still worth it + tooling can help)"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"additional-tools",children:"Additional tools"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Terragrunt","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Minimizes code repetition"}),"\n",(0,i.jsx)(n.li,{children:"Enables multi-account separation (improved isolation/security)"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Cloud Nuke","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Easy cleanup of cloud resources"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Makefiles","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Prevent human error"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"potential-pitfalls",children:"Potential pitfalls"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Name changes when refactoring may cause destroy/recreate resources"}),"\n",(0,i.jsxs)(n.li,{children:["Sensitive data in terraform ",(0,i.jsx)(n.em,{children:"state file"})]}),"\n",(0,i.jsx)(n.li,{children:"Cloud timeouts on command execution"}),"\n",(0,i.jsx)(n.li,{children:"Naming conflicts"}),"\n",(0,i.jsx)(n.li,{children:"Forgetting to destroy test-infra"}),"\n",(0,i.jsxs)(n.li,{children:["Uni-directional version upgrades with different terraform versions","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["terraform ",(0,i.jsx)(n.em,{children:"state files"})," can be associated with the version of terraform binaries"]}),"\n",(0,i.jsx)(n.li,{children:"make sure to use the same terraform version in e.g. developers local environment, CI/CD system etc."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Multiple ways to accomplish same configuration"}),"\n",(0,i.jsx)(n.li,{children:"Some Params are immutable"}),"\n",(0,i.jsx)(n.li,{children:"Out of band changes, e.g. without terraform manually or other tools rather than terraform"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"commands",children:"Commands"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"# INIT\nterraform init\n\n# PLAN\nterraform plan\n\n# APPLY\nterraform apply\n\n# DESTROY\nterraform destroy\n\n# WORKSPACE\nterraform workspace list\nterraform workspace new <name-of-workspace>\n\n# GRAPH\nterraform graph | dot -Tpng > graph.png                        # create dependency graph\n"})}),"\n",(0,i.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://developer.hashicorp.com/terraform",children:"Terraform Documentation"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://developer.hashicorp.com/terraform/language",children:"Terraform Language Documentation"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://youtu.be/7xngnjfIlK4?si=XT2rH3c0AWKhG03F",children:"Complete Terraform Course - From BEGINNER to PRO! by DevOps Directive"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>o});var s=r(6540);const i={},l=s.createContext(i);function a(e){const n=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);